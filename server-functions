#!/bin/bash

export MAILSERVER_HOME=${MAILSERVER_HOME:-/var/lib/mailu}
export MAILSERVER_CONFIGURATION_FILE=${MAILSERVER_CONFIGURATION_FILE:-${MAILSERVER_HOME}/mailu.env}
export MAILSERVER_DATA_FILESYSTEM=${MAILSERVER_DATA_FILESYSTEM:-mailserver-data}
export MAILSERVER_DATA_MOUNTPOINT=${MAILSERVER_DATA_MOUNTPOINT:-/var/mail}
export MAILSERVER_DOCKER_COMPOSE_FILE=${MAILSERVER_DOCKER_COMPOSE_FILE:-${MAILSERVER_HOME}/docker-compose.yml}
export MAILSERVER_TOOLS_URL_PREFIX=${MAILSERVER_TOOLS_URL_PREFIX:-https://raw.githubusercontent.com/jim-hanlon/m-s/main}

prg=${BASH_SOURCE[0]}
[[ ( -n "${prg}" ) && ( -f "${prg}" ) ]] || (echo "[FATAL] cannot locate: '$0'" 1>&2)
task=$(basename -- "${prg}")
prgdir=$(dirname -- "${prg}")
prgdir=$(cd "${prgdir}" > /dev/null && pwd)

source "${prgdir}/route-53-functions"


function instance:create-tag() {
    local key=${1:?Need key}
    local value=${2?Need value}
    local instanceId=$(instance:id)
    local region=$(instance:region)
    aws ec2 create-tags --region "${region}" --resources "${instanceId}" --tags Key="${key}",Value="${value}"
}


function instance:delete-tag() {
    local key=${1:?Need key}
    local value=${2:-''}
    local instanceId=$(instance:id)
    local region=$(instance:region)
    local tags=Key=${key}
    [[ -n "${value}" ]] && tags="${tags},Value=${value}"
    aws ec2 delete-tags --region "${region}" --resources "${instanceId}" --tags "${tags}"
}


function instance:id() {
    curl -s http://169.254.169.254/latest/meta-data/instance-id
}


function instance:public-hostname() {
    curl -s http://169.254.169.254/latest/meta-data/public-hostname
}


function instance:public-ipv4() {
    curl -s http://169.254.169.254/latest/meta-data/public-ipv4
}


function instance:read-tag() {
    local key=${1:?Need key}
    local instanceId=$(instance:id)
    local region=$(instance:region)
    aws ec2 describe-tags --region "${region}" \
        --filters Name=resource-id,Values=${instanceId} Name=key,Values=$key | jq '.Tags[].Value'
}


function instance:region() {
    curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | \
    jq '.region' | \
    tr -d '"'
}


function instance:set-a-records() {
    local ec2PublicIpv4=$(instance:public-ipv4)
    route-53:set-ipv4-a-record "${ec2PublicIpv4}" 300 "${@}"
}


function instance:set-cname-records() {
    local ec2PublicHostname=$(instance:public-hostname)
    route-53:set-ipv4-a-record "${ec2PublicHostname}" 300 "${@}"
}


function mailserver:idle() {
    cd "${MAILSERVER_HOME}"
    docker-compose -p mailu stop
}


function mailserver:initialize() {
    mailserver:mount-mailserver-data
    mailserver:install_mailu_configuration
    mailserver:set-a-records
}


function mailserver:install() {
        while [[ "${lastBootstrapStatus}" != "complete" ]]; do

    if [[ $(instance:read-tag BootstrapStatus) != "complete]]; then
        instance:create-tag BootstrapStatus 'initializing-mailserver'
        mailserver:initialize
        mailserver:start
        for hostname in $(grep HOSTNAMES ${MAILSERVER_CONFIGURATION_FILE} | cut -d= -f2 | cut -d, -f1); do
            hostname=$(echo "${hostname}" | sed -E 's/^mail\.//')
            docker-compose -p mailu exec admin flask mailu admin  --mode update postmaster ${hostname} postmaster
        done
        (crontab -l 2>/dev/null | grep -v @reboot; echo "@reboot /bin/bash -c 'source ${MAILSERVER_HOME}/server-functions && instance:create-tag BootstrapStatus complete && mailserver:initialize && mailserver:start'") | crontab -
    fi
    local upgradable=$(sudo apt list --upgradable 2>/dev/null | tail -n +2 | cut -d/ -f1)
    if [[ -n "${upgradable}" ]]; then
        instance:create-tag BootstrapStatus "upgrading ${upgradable}"
        apt-get install -y ${upgradable}
    fi
    if [[ -f /var/run/reboot-required ]]; then
        instance:create-tag BootstrapStatus rebooting
        reboot
    else
        instance:create-tag BootstrapStatus complete
    fi
}


function mailserver:install_mailu_configuration() {
    cd "${MAILSERVER_HOME}"
    git pull
    local mailuKey=$(head /dev/urandom | tr -dc A-Z0-9 | head -c 16)
    local version=$(( $(ls -1 "${MAILSERVER_CONFIGURATION_FILE}*" 2>/dev/null | grep -E '\.env(.[1-9][0-9]*)?$' | wc -l ) + 1 ))
    [[ -f "${MAILSERVER_CONFIGURATION_FILE}" ]] && cp "${MAILSERVER_CONFIGURATION_FILE}" "${MAILSERVER_CONFIGURATION_FILE}.${version}"
    cat "${MAILSERVER_CONFIGURATION_FILE}.${version}" | sed -E 's/^SECRET_KEY=.*$/SECRET_KEY='${mailuKey}'/' > "${MAILSERVER_CONFIGURATION_FILE}"

    local localIPv4=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)
    version=$(( $(ls -1 "${MAILSERVER_DOCKER_COMPOSE_FILE}*" 2>/dev/null | grep -E '\.env(.[1-9][0-9]*)?$' | wc -l ) + 1 ))
    [[ -f "${MAILSERVER_DOCKER_COMPOSE_FILE}" ]] && cp "${MAILSERVER_DOCKER_COMPOSE_FILE}" "${MAILSERVER_DOCKER_COMPOSE_FILE}.${version}"
    cat "${MAILSERVER_DOCKER_COMPOSE_FILE}.${version}" | sed 's/XXX\.XXX\.XXX\.XXX/'${localIPv4}'/g' > "${MAILSERVER_DOCKER_COMPOSE_FILE}"
    
}


function mailserver:mail-server-names() {
    echo $(for d in $(grep HOSTNAMES "${MAILSERVER_CONFIGURATION_FILE}" | cut -d= -f2 | cut -d, --output-delimiter ' ' -f1-); do echo "mail.${d}"; done)
}


function mailserver:mount-mailserver-data() {
    local availabilityZone=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | jq '.availabilityZone' | tr -d '"')
    local region=$(instance:region)
    local fileSystemId=$(aws --region ${region} efs describe-file-systems | \
                         jq '.FileSystems | select(.[].Tags[].Key == "Name") | select(.[].Tags[].Value == "'${MAILSERVER_DATA_FILESYSTEM}'") | .[].FileSystemId' | tr -d '"')
    local fileSystemName="${fileSystemId}.efs.${region}.amazonaws.com" 
    echo "${fileSystemName}:/ ${MAILSERVER_DATA_MOUNTPOINT} nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 0 0" >> /etc/fstab
    mkdir -p "${MAILSERVER_DATA_MOUNTPOINT}"
    chown nobody:nogroup "${MAILSERVER_DATA_MOUNTPOINT}"
    mount "${MAILSERVER_DATA_MOUNTPOINT}"
}


function mailserver:set-a-records() {
    instance:set-a-records $(mailserver:mail-server-names)
}


function mailserver:set-cnames() {
    instance:set-cname-records  $(mailserver:mail-server-names)
}


function mailserver:start() {
    cd "${MAILSERVER_HOME}"
    docker-compose -p mailu up -d
}


function mailserver:stop() {
    cd "${MAILSERVER_HOME}"
    docker-compose -p mailu down --remove-orphans
}


